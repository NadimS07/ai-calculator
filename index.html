<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@11/lib/browser/math.js" defer></script>
  <style>
    :root{--bg:#0f1220;--card:#171b2e;--ink:#e9ecff;--muted:#aab0d4;--accent:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0f1220,#0b0f1c);color:var(--ink);
      font:16px/1.4 system-ui,Segoe UI,Roboto,Inter,sans-serif;display:flex;min-height:100vh}
    .wrap{max-width:900px;margin:auto;padding:28px;width:100%}
    .title{font-size:28px;font-weight:800;margin:0 0 4px}
    .subtitle{color:var(--muted);margin:0 0 24px}
    .card{background:var(--card);border:1px solid #2a3152;border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .inputWrap{flex:1;display:flex;gap:10px;align-items:center}
    input[type=text]{flex:1;background:#0f1427;border:1px solid #2a3152;border-radius:12px;
      padding:14px 16px;color:var(--ink);font-size:16px;outline:none}
    input[type=text]::placeholder{color:#6f77a6}
    button{background:var(--accent);color:#0a0d1a;border:none;border-radius:12px;
      padding:12px 16px;font-weight:600;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .mic{display:inline-flex;align-items:center;gap:8px;background:#0f1427;color:var(--ink);
      border:1px solid #2a3152}
    .mic.listening{box-shadow:0 0 0 2px #2a3152,0 0 0 6px rgba(122,162,255,.25)}
    .status{font-size:12px;color:var(--muted)}
    .out{margin-top:14px;padding:14px 16px;background:#0f1427;border:1px dashed #2a3152;border-radius:12px;white-space:pre-wrap}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .chip{background:#0f1427;border:1px solid #2a3152;border-radius:999px;padding:8px 10px;font-size:13px;cursor:pointer;color:#fff}
    .history{margin-top:18px}
    .history h3{margin:0 0 8px;font-size:15px;color:var(--muted);font-weight:600}
    .history ul{margin:0;padding-left:20px;font-size:14px;color:#cdd2ff}
    .small{font-size:12px;color:#9aa2d9}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">AI Calculator</h1>
    <p class="subtitle">Type or speak what you mean. I‚Äôll figure out the math.</p>

    <div class="card">
      <div class="row">
        <div class="inputWrap">
          <input id="q" type="text" placeholder='Try: "15% of 120", "sin 30 degrees", "5 km to miles"' />
          <button id="mic" class="mic" title="Toggle voice (Ctrl+M)">üé§ <span id="micLabel">Speak</span></button>
        </div>
        <button id="go">Calculate</button>
      </div>
      <div class="status" id="vStatus"></div>

      <div class="chips" id="chips"></div>
      <div class="out" id="out">Result will appear here.</div>

      <div class="history">
        <h3>History</h3>
        <ul id="hist"></ul>
        <div class="small">Tips: ‚Äúadd 5 and 7 * 3‚Äù, ‚Äúsquare root of 81‚Äù, ‚Äúuse last / 4‚Äù. Last keyword: <code>last</code>.</div>
      </div>
    </div>
  </div>

  <script defer>
  (function(){
    // DOM
    const qEl = document.getElementById('q');
    const outEl = document.getElementById('out');
    const goEl = document.getElementById('go');
    const histEl = document.getElementById('hist');
    const chipsEl = document.getElementById('chips');
    const micBtn = document.getElementById('mic');
    const micLabel = document.getElementById('micLabel');
    const vStatus = document.getElementById('vStatus');

    // Core
    let lastAnswer = null;
    const history = [];
    const examples = [
      "what's 15% of 120",
      "add 5 and 7 then multiply by 3",
      "square root of 81",
      "2 to the power of 5",
      "sin 30 degrees",
      "convert 5 km to miles",
      "40 celsius to fahrenheit",
      "use last answer / 4"
    ];
    examples.forEach(e=>{
      const c=document.createElement('button');
      c.className='chip'; c.textContent=e;
      c.onclick=()=>{ qEl.value=e; process(); };
      chipsEl.appendChild(c);
    });

    function escapeHtml(s){ return s.toString().replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
    function showResult(text){ outEl.textContent = text; }
    function pushHistory(input, result){
      history.unshift({input, result});
      histEl.innerHTML = history.map(h => `<li><strong>${escapeHtml(h.input)}</strong> = ${escapeHtml(h.result.toString())}</li>`).join('');
    }
    function formatNumber(n){ return (typeof n === 'number' && !Number.isInteger(n)) ? String(Number(n.toFixed(8))) : String(n); }

    // Natural language ‚Üí math.js plan
    function nlToPlan(raw){
      let s = ' ' + raw.toLowerCase().trim() + ' ';
      if (lastAnswer !== null){
        s = s.replace(/\blast answer\b/g, lastAnswer.toString());
        s = s.replace(/\blast\b/g, lastAnswer.toString());
      }
      // unit conversions like "5 km to miles"
      const conv1 = s.match(/(?:convert\s+)?([\d\.\-e]+)\s*([a-z¬∞]+)\s+(?:to|in)\s+([a-z¬∞]+)/);
      if (conv1) return { type:'convert', value: conv1[1], from: conv1[2], to: conv1[3] };
      // temperature words
      const c2 = s.match(/([\d\.\-e]+)\s*(c|celsius|¬∞c)\s+(?:to|in)\s*(f|fahrenheit|¬∞f)/);
      if (c2) return { type:'temp', value:c2[1], from:'C', to:'F' };
      const c3 = s.match(/([\d\.\-e]+)\s*(f|fahrenheit|¬∞f)\s+(?:to|in)\s*(c|celsius|¬∞c)/);
      if (c3) return { type:'temp', value:c3[1], from:'F', to:'C' };

      // percent, sqrt, trig(deg), power
      s = s.replace(/(\d+(?:\.\d+)?)\s*%?\s*(percent)?\s*of\s*(\d+(?:\.\d+)?)/g, '($1/100)*$3');
      s = s.replace(/square\s+root\s+of\s+(\d+(?:\.\d+)?)/g, 'sqrt($1)');
      s = s.replace(/(sin|cos|tan)\s+(\-?\d+(?:\.\d+)?)\s*degrees?/g, '$1($2 deg)');
      s = s.replace(/(\d+(?:\.\d+)?)\s+(?:to\s+the\s+power\s+of|power\s+of|power)\s+(\-?\d+(?:\.\d+)?)/g, '($1^$2)');

      // operators
      [
        [/divided\s+by/g,'/'],
        [/\bover\b/g,'/'],
        [/multiply\s+by|times|multiplied\s+by/g,'*'],
        [/plus|add(ed)?|and/g,'+'],
        [/minus|subtract(ed)?/g,'-'],
      ].forEach(([r,t])=> s = s.replace(r,t));

      // filler cleanup
      s = s.replace(/\bwhat(?:'|‚Äô)s\b|\bwhat is\b|\bcalculate\b|\bhow much is\b|\bplease\b|\bthen\b/gi,' ');
      s = s.replace(/\s+/g,' ').trim();

      return { type:'expr', expr: s };
    }

    function process(){
      const input = qEl.value.trim();
      if (!input){ showResult("Please type or say something to calculate."); return; }
      try{
        const plan = nlToPlan(input);
        let rendered = '';
        if (plan.type === 'convert'){
          const u = math.unit(Number(plan.value), plan.from);
          const result = u.to(plan.to);
          rendered = `${plan.value} ${plan.from} = ${result.toString()}`;
          lastAnswer = Number(result.toNumber ? result.toNumber() : result.value);
        } else if (plan.type === 'temp'){
          let result;
          if (plan.from==='C' && plan.to==='F'){ result = Number(plan.value) * 9/5 + 32; rendered = `${plan.value} ¬∞C = ${formatNumber(result)} ¬∞F`; }
          else { result = (Number(plan.value) - 32) * 5/9; rendered = `${plan.value} ¬∞F = ${formatNumber(result)} ¬∞C`; }
          lastAnswer = result;
        } else {
          const res = math.evaluate(plan.expr);
          if (math.typeOf(res) === 'Unit'){ rendered = res.toString(); lastAnswer = Number(res.toNumber()); }
          else if (math.typeOf(res) === 'BigNumber'){ rendered = res.toString(); lastAnswer = Number(res.toNumber()); }
          else { rendered = formatNumber(res); lastAnswer = Number(res); }
        }
        showResult(rendered);
        pushHistory(input, rendered);
      } catch (e){
        showResult("Sorry, I couldn't parse that.\nDetails: " + e.message);
        console.error(e);
      }
    }
    goEl.addEventListener('click', process);
    qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') process(); });

    // Voice input (optional, Chrome/Edge)
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let rec = null, listening = false, bufferText = '';
    if (!SR){
      micBtn.disabled = true;
      micBtn.title = "Voice not supported here";
    } else {
      rec = new SR();
      rec.lang = 'en-IN';     // change to 'en-US' if you like
      rec.interimResults = true;
      rec.continuous = true;

      rec.onstart = () => { listening = true; micBtn.classList.add('listening'); micLabel.textContent = 'Listening‚Ä¶'; vStatus.textContent = 'Speak your calculation.'; bufferText = ''; };
      rec.onresult = (e) => {
        let finalText = '', interimText = '';
        for (let i = e.resultIndex; i < e.results.length; i++){
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalText += t + ' ';
          else interimText += t + ' ';
        }
        if (interimText) qEl.value = bufferText + interimText.trim();
        if (finalText){ bufferText += finalText; qEl.value = bufferText.trim(); process(); }
      };
      rec.onerror = (e) => { vStatus.textContent = 'Voice error: ' + (e.error || 'unknown'); stopListening(); };
      rec.onend = () => { stopListening(false); };

      function startListening(){ if (!listening){ vStatus.textContent=''; try{ rec.start(); }catch{} } }
      function stopListening(reset=true){ if(listening){ listening=false; micBtn.classList.remove('listening'); micLabel.textContent='Speak'; try{rec.stop();}catch{} if(reset) vStatus.textContent=''; } }

      micBtn.addEventListener('click', ()=> listening ? stopListening() : startListening());
      window.addEventListener('keydown', (e)=>{
        if (e.ctrlKey && (e.key==='m' || e.key==='M')){ e.preventDefault(); listening ? stopListening() : startListening(); }
      });
    }

    setTimeout(()=> qEl.focus(), 0);
  })();
  </script>
</body>
</html>
